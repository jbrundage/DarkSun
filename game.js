const express = require('express');
const bodyparser = require('body-parser');
const mongo = require('mongoose');

const auth_db = require('./src_server/auth_db');
const game_db = require('./game_server/db');
const auth_helper = require('./src_server/auth_helper');

const dev_tools = require('./src_server/tools');
const game_config = require('./game_server/config');

let app = express();
app.listen(80);
app.get('/', landing_page);
app.use('/src_client', express.static('src_client')); /* for abstract css/js/img */
app.use('/game_client', express.static('game_client')); /* for game-specific css/js/img */

let urlencodedparser = bodyparser.urlencoded({extended:false});
mongo.connect(`mongodb://localhost/${game_config.db}`, function(){}).then(() => {})
    .catch(err => {
        console.error(err.stack);
        process.exit(1);
    });
mongo.Promise = global.Promise;

app.post('/create_user',urlencodedparser,function(request, response){
    let obj = JSON.parse(JSON.stringify(request.body));
    new auth_db.users(obj).save()
    .then(resp => response.send(resp))
    .catch(resp => console.error(resp))
});
app.post('/update_user',urlencodedparser,function(request, response){
    auth_helper.session_handshake(request.body.session_key,function(user_session_doc){
        console.info(`user_session_doc`,user_session_doc);
        if(user_session_doc){
            console.info('This is where the update user logic will go...');
        }
        response.send(user_session_doc);
    });
});
app.post('/submit_login',urlencodedparser,function(request, response){
    auth_helper.get_user_session(request.body.username, request.body.password, function(user_session_doc){
        user_session_doc.json = JSON.stringify({
            saved_games_arr: [{
                name: "New Game",
                ship_json: {
                    "vertices":[0.941296,0.194107,1.9317,1.87441,0.194107,2.89755,1.07226,0.194107,3.96162,-0.941295,0.194107,3.89614,-2.03811,0.194107,2.88118,-1.02315,0.194115,1.89896,-1.02315,0.194115,-0.900369,-0.040926,0.194115,-2.01355,0.957667,0.194107,-1.0477,-0.040926,-0.305903,-0.998591,0.00818519,-0.30588,2.89755,-0.0281831,-0.30588,1.81499,-0.0203851,0.194145,3.91393,0.957667,0.194107,-1.0477,-0.040926,0.194115,-2.01355,-1.02315,0.194115,-0.900369,0.941296,0.194107,1.9317,1.87441,0.194107,2.89755,1.07226,0.194107,3.96162,-0.0203851,0.194145,3.91393,-2.03811,0.194107,2.88118,-0.941295,0.194107,3.89614,-1.02315,0.194115,1.89896,0.957668,0.694107,-1.0477,-0.0409251,1.1941,-0.998593,-0.0409251,0.694115,-2.01355,0.00818604,1.19412,2.89755,-0.0281823,1.19412,1.81499,-1.02315,0.694115,-0.900371,0.941297,0.694107,1.9317,1.87441,0.694107,2.89755,1.07226,0.694107,3.96162,-0.0203843,0.694145,3.91393,-2.03811,0.694107,2.88118,-0.941294,0.694107,3.89614,-1.02315,0.694115,1.89896],
                    "faces":[40,11,0,10,0,1,2,0,0,0,40,6,7,9,3,4,5,1,1,1,40,11,10,5,0,2,6,2,2,2,41,6,9,11,5,3,5,0,6,3,3,3,3,40,9,7,8,5,4,7,4,4,4,41,0,11,9,8,1,0,5,7,5,5,5,5,40,0,1,10,1,8,2,6,6,6,40,1,2,10,8,9,2,7,7,7,40,10,2,12,2,9,10,8,8,8,40,3,10,12,11,2,10,9,9,9,40,3,4,10,11,12,2,10,10,10,40,5,10,4,6,2,12,11,11,11,41,16,13,23,29,13,14,15,16,12,12,12,12,41,21,19,32,34,17,18,19,20,13,13,13,13,41,15,22,35,28,21,22,23,24,14,14,14,14,41,19,18,31,32,18,25,26,19,15,15,15,15,41,18,17,30,31,25,27,28,26,16,16,16,16,41,22,20,33,35,22,29,30,23,17,17,17,17,41,13,14,25,23,14,31,32,15,18,18,18,18,41,17,16,29,30,33,13,16,34,19,19,19,19,41,20,21,34,33,35,17,20,36,20,20,20,20,41,14,15,28,25,37,21,24,38,21,21,21,21,41,4,3,21,20,39,39,39,39,22,22,22,22,41,1,0,16,17,39,39,39,39,22,22,22,22,41,8,7,14,13,39,39,39,39,22,22,22,22,41,5,4,20,22,39,39,39,39,22,22,22,22,41,2,1,17,18,39,39,39,39,22,22,22,22,41,12,2,18,19,39,39,39,39,22,22,22,22,41,6,5,22,15,39,39,39,39,22,22,22,22,41,3,12,19,21,39,39,39,39,22,22,22,22,41,0,8,13,16,39,39,39,39,22,22,22,22,41,7,6,15,14,39,39,39,39,22,22,22,22,40,27,26,29,40,41,42,23,23,23,40,28,24,25,43,44,45,24,24,24,40,27,35,26,40,46,41,25,25,25,41,28,35,27,24,43,46,40,44,26,26,26,26,40,24,23,25,44,47,45,27,27,27,41,24,27,29,23,44,40,42,47,28,28,28,28,40,29,26,30,42,41,48,29,29,29,40,30,26,31,48,41,49,30,30,30,40,26,32,31,41,50,49,31,31,31,40,34,32,26,51,50,41,32,32,32,40,34,26,33,51,41,52,33,33,33,40,35,33,26,46,52,41,34,34,34],
                    "uvs":[[0.720969,0.599293,0.717609,0.506739,0.837974,0.596313,0.439772,0.740224,0.304044,0.620188,0.415636,0.597166,0.74375,0.743871,0.393829,0.500882,0.808384,0.39534,0.936057,0.493572,0.947396,0.62543,0.959386,0.73659,0.865752,0.867689,0.314878,0.847286,0.560494,0.840856,0.561133,0.908726,0.315518,0.915156,0.592345,0.975801,0.484407,0.978621,0.483767,0.910752,0.591705,0.907931,0.549436,0.841145,0.312182,0.847356,0.311542,0.779487,0.548797,0.773276,0.356242,0.981982,0.355603,0.914112,0.266205,0.984339,0.265565,0.916469,0.146783,0.851687,0.146144,0.783818,0.723284,0.836595,0.723924,0.904464,0.157512,0.851407,0.158152,0.919277,0.724564,0.972339,0.723924,0.904469,0.723284,0.836594,0.722645,0.768725,0.352192,0.49446,0.543655,0.240688,0.6632,0.236869,0.543792,0.385234,0.242151,0.163729,0.232473,0.260743,0.113172,0.293928,0.551832,0.142206,0.214092,0.410169,0.645101,0.493366,0.767578,0.385846,0.768789,0.250896,0.772288,0.136988,0.666517,0.00896084]],
                    "normals":[0.459775,-0.887901,-0.0154459,-0.447824,-0.802072,-0.395139,-0.447953,-0.89393,0.0150488,-0.451256,-0.892394,0.00102814,0.393034,-0.824859,-0.406365,0.452981,-0.89152,0.000287244,0.25106,-0.93709,-0.24255,0.253999,-0.948062,0.191477,-0.0192771,-0.89734,0.440919,-0.00848535,-0.897354,0.441229,-0.231686,-0.94002,0.250369,-0.228838,-0.944306,-0.236473,0.999985,-1.65043e-06,0.00549458,-0.0193117,3.37107e-06,0.999814,-1,1.66893e-06,-8.51699e-08,-0.0436077,3.40959e-06,0.999049,0.798523,7.15676e-07,0.601965,-0.695421,-1.18162e-06,-0.718602,0.695224,-3.56101e-06,-0.718793,0.719192,-3.50624e-06,-0.694812,-0.679191,3.66952e-06,0.733962,-0.749838,-1.04389e-06,-0.661622,0,0,0,0.459793,0.887892,-0.0154466,-0.447803,0.802092,-0.395121,-0.44796,0.893927,0.0150491,-0.451248,0.892398,0.00102076,0.393025,0.824874,-0.406343,0.452983,0.891519,0.000280131,0.251072,0.937085,-0.242561,0.254011,0.948057,0.191485,-0.019213,0.897358,0.440885,-0.00855894,0.897372,0.441191,-0.231696,0.940014,0.25038,-0.228849,0.944304,-0.236471],
                    "metadata":{
                        "faces":44,
                        "vertices":36,
                        "type":"Geometry",
                        "generator":"io_three",
                        "normals":35,
                        "version":3,
                        "uvs":1
                    }
                },
                ship_texture: "/game_client/texture.jpg"
            }]
        })
        response.send(user_session_doc);
    });
});
function landing_page(request, response) {
    console.info(`request`,request);
    response.send(`
        <html>
            <head>
                <title>${game_config.name}</title>
                <script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
                <link rel="stylesheet" href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'></link>
                
                <link rel="stylesheet" href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css'></link>
                <script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js'></script>
                
                <link rel="stylesheet" type="text/css" href="src_client/style.css"></link>
                <script src="src_client/three.min.js"></script>
                <script src="src_client/game_renderer.js"></script>
                
                <script src="src_client/main.js"></script>
                <script src="src_client/gui.js"></script>
                <script src="src_client/tools.js"></script>
                <script src="src_client/utility.js"></script>
            </head>
            <body>
            <div id="login_background" style="height: 500px; width: 500px;">
            </div>
            <script>
                $(function(){
                    $('body').append(login_form());
                })
            </script>
            </body>
        </html>
    `);
}
